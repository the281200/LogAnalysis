@model ErrorsRequestStatusCode
@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Phiên truy cập lỗi";

}
<script type="text/javascript">
    var rowselected = [];
    var isCheckedAll = false;

    function binding_handler(e) {
    }

   @* function changepassword_handler(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        opendlg("/admin/Customer/changepassword/?userName=" + dataItem.UserName);
    }*@

    function delete_handler(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        opendlg("/admin/IncurredPurchases/delete/" + dataItem.ID);
    }

    function edit_handler(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        opendlg("/admin/IncurredPurchases/edit/" + dataItem.ID);
    }

    function modules_handler(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        opendlg("/admin/IncurredPurchases/ModulesMapping/" + dataItem.ID);

    }

    function sites_handler(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        opendlg("/admin/IncurredPurchases/AdminSitesMapping/" + dataItem.ID);
    }

    $(document).ready(function () {

        $(".input-submit").click(function (e) {
            e.preventDefault();
            var dataSource = $("#grid").data("kendoGrid").dataSource.data();
            var models = [];

            for (var j = 0; j < dataSource.length; j++) {
                var dataItem = dataSource[j];
                var model = {};
                model.ID = dataItem.ID;
                model.date = dataItem.date;
                model.csMethod = dataItem.csMethod;
                model.cIp = dataItem.cIp;
                model.csVersion = dataItem.csVersion;
                model.scStatus = dataItem.scStatus;
                model.scBytes = dataItem.scBytes;
                model.csBytes = dataItem.csBytes;
                model.timeTaken = dataItem.timeTaken;

                models.push(model);
            }

            var dataSubmit = JSON.stringify(models)
            $("input[name='dataString']").val(dataSubmit);

            setTimeout(function () {
                $("#general").submit();
            }, 100);
        });

        $("#FieldFilter").keyup(function () {
            var value = $("#FieldFilter").val();
@*            if (value == "") {
                rowselected = [];
                isCheckedAll = false;

                $('input[name="checkedNodes"]').each(function () {
                    $(this).prop('checked', isCheckedAll);
                });

                $('#chkAll').prop('checked', isCheckedAll);
            }*@

            var int = parseInt(value);
            var float = parseFloat(value);

            $("#grid").data("kendoGrid").dataSource.filter({
                logic: "or",
                filters: [

                    {
                        field: "csMethod",
                        operator: "contains",
                        value: value
                    },
                    {
                        field: "cIp",
                        operator: "contains",
                        value: value
                    },
                    {
                        field: "scStatus",
                        operator: "eq",
                        value: float
                    }
                ]
            });
        });
    });

    function onDataBound(e) {
        $('#grid .k-grid-content').height(screen.height * 0.5);

        $('input[name="checkedNodes"]').each(function () {
            if (rowselected.indexOf(this.value) != -1) {
                $(this).attr('checked', 'checked');
            } else {
                $(this).removeAttr('checked');
            }
        });
    };
</script>
<div id="main">
    <div id="left"></div>
    <div class="container-fluid box-log">
        <div class="row log-content">
            <div class="col-sm-3 log-item">
                <h2>Failed Request</h2><br />
                <strong class="color-green"> @Model.FailedRequest</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>4xx Status Codes </h2><br />
                <strong class="color-blue">@Model.FourHundredStatusCodes</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>5xx Status Codes </h2><br />
                <strong class="color-yellow">@Model.FiveHundredStatusCodes</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>Bad Request Status Codes </h2><br />
                <strong class="color-red">@Model.BadRequestStatusCodes</strong>
            </div>
        </div>
        <div class="row log-content">
            <div class="col-sm-3 log-item">
                <h2>Unauthorized Status Codes </h2><br />
                <strong class="color-red">@Model.UnauthorizedStatusCodes</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>Forbiden Status Codes </h2><br />
                <strong class="color-yellow">@Model.ForbidenStatusCodes</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>NotFound Status Codes </h2><br />
                <strong class="color-bluemix">@Model.NotFoundStatusCodes</strong>
            </div>
            <div class="col-sm-3 log-item">
                <h2>Internal Server Error Status Codes </h2><br />
                <strong class="color-green">@Model.InternalServerErrorStatusCodes</strong>
            </div>
        </div>
        <div class="row log-content">
            <div class="col-sm-4 log-item">
                <h2>Bad Gateway Status Codes </h2><br />
                <strong class="color-bluemix">@Model.BadGatewayStatusCodes</strong>
            </div>
            <div class="col-sm-4 log-item">
                <h2>Service Unavailable Status Codes </h2><br />
                <strong class="color-green">@Model.ServiceUnavailableStatusCodes</strong>
            </div>
            <div class="col-sm-4 log-item">
                <h2>Gateway Timeout Status Codes </h2><br />
                <strong class="color-red">@Model.GatewayTimeoutStatusCodes</strong>
            </div>
        </div>

        <div class="container-fluid">
            <div class="chart-content">
                <div class="row ">
                    @*                    <div class="col-sm-4 p-0">
                            <div class="chart-cursor">
                                <canvas id="chart1"></canvas>
                            </div>
                        </div>*@
                    <div class="col-sm-6 p-0">

                        <div class="chart-cursor">
                            <div class="text-chart">Top Paths</div>
                            <canvas id="topPaths"></canvas>
                        </div>
                    </div>
                    <div class="col-sm-6 p-0">
                        <div class="chart-cursor">
                            <div class="text-chart">Top Client IP</div>
                            <canvas id="topClientIP"></canvas>
                        </div>
                    </div>

                </div>
            </div>
            <div class="chart-content">
                <div class="row ">
                    <div class="col-sm-6 p-0">
                        <div class="chart-cursor">
                            <div class="text-chart">Top Protocol Version</div>
                            <canvas id="topProtocolVersion"></canvas>
                        </div>
                    </div>
                    <div class="col-sm-6 p-0">

                        <div class="chart-cursor">
                            <div class="text-chart">Top Http Method</div>
                            <canvas id="topHttpMethod"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid box-grid">
            <div class="flex row-quanlyxe block-div mobile-tools-bar">
                <div class="flex">
                    <div class="manage-car-search row-plan-drive d-none">
                        <form action="">
                            <img src="~/Content/themes/admin/img/Vector-kehoach.png" alt="calendar" class="img-box-date-picker img-form-plan-drive img-calander-plan-drive">
                            <input type="text" name="daterange" class="box-date-picker" id="time" value="@ViewBag.Date">
                        </form>
                    </div>
                    <div class="manage-car-search row-plan-drive">
                        <form action="">
                            <img src="~/Content/themes/admin/img/Vector-search1.png" alt="search" class="img-box-search img-form-plan-drive">
                            <input id='FieldFilter' type="text" name="" placeholder="Tìm kiếm" class="box-search box-search-quanlyxe">
                        </form>
                    </div>
                </div>

                <div class="flex block-two-row">

                    @using (Html.BeginForm("ExportExcel", "RequestPerformance", FormMethod.Post, new { @id = "general", enctype = "multipart/form-data", @class = "form-horizontal fix" }))
                    {
                        @Html.HiddenFor(m => m.dataString)
                        <div class="btn-download btn-plan-drive input-submit">
                            <img src="~/Content/themes/admin/img/Vector-download.png" alt="text-14-700">
                            <input id="exportData" type="submit" class="text-14-500 padding-text-plan-drive" value="Tải xuống">
                        </div>
                    }

                </div>
            </div>
            <div class="">
                <div class="box">
                    <div class="box-content nopadding">
                        @(Html.Kendo().Grid<LogData>()
                                .Name("grid")
                                .Columns(columns =>
                                {
                                    columns.Bound(p => p.ID).Title(Resources.Common.ID).HtmlAttributes(new { style = "text-align:center;" }).Hidden();
                                    columns.Bound(p => p.ID).Title(Resources.Common.ID).HtmlAttributes(new { style = "text-align:center;" }).Hidden();
                                    columns.Bound(p => p.date).Title("Thời gian").Format("{0:dd-MM-yyyy HH:mm:ss}").Width(400);
                                    columns.Bound(p => p.csMethod).Title("Phương thức HTTP").Width(200);
                                    columns.Bound(p => p.cIp).Title("IP người dùng").Width(150);
                                    columns.Bound(p => p.csVersion).Title("Phiên bản HTTP").Width(300);
                                    columns.Bound(p => p.scStatus).Title("Mã trạng thái HTTP").Width(300);
                                    columns.Bound(p => p.scBytes).Title("Số byte gửi").Width(300);
                                    columns.Bound(p => p.csBytes).Title("Số byte nhận").Width(300);
                                    columns.Bound(p => p.timeTaken).Title("Thời gian thực hiện (ms)").Width(300);
                                })
                                .Pageable()
                                .Selectable(select => select.Mode(GridSelectionMode.Single))
                                .Sortable()
                                .Filterable()
                                .DataSource(dataSource => dataSource
                                    .Ajax()
                                    .Model(model => model.Id(p => p.ID))
                                    .PageSize(20)
                                    .Read(read => read.Action("RequestPerformance_Read", "RequestPerformance"))
                                    .ServerOperation(false)
                                 )
                                  .Events(events => events.DataBinding("binding_handler").DataBound("onDataBound"))
                        )


                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script>
    //option

    var chartBarType = 'bar';





    var xAxesBarChart = [];
    var yAxesBarChart = [];


    var xAxesTopPaths = [];
    var yAxesTopPaths = [];

    var xAxesClientIP = [];
    var yAxesClientIP = [];

    var xAxesProtocolVersion = [];
    var yAxesProtocolVersion = [];

    var xAxesHttpMethod = [];
    var yAxesHttpMethod = [];


@*    var ctxBarChart = document.getElementById('chart1').getContext('2d');*@
    var ctxTopPaths = document.getElementById('topPaths').getContext('2d');
    var ctxClientIP = document.getElementById('topClientIP').getContext('2d');
    var ctxProtocolVersion = document.getElementById('topProtocolVersion').getContext('2d');
    var ctxHttpMethod = document.getElementById('topHttpMethod').getContext('2d');



//create stack bar chart
@*    const dataBarChart = {
        labels: xAxesBarChart,
        datasets: yAxesBarChart,
        backgroundColor: yAxesBarChart.backgroundColor,
    };

    var barChart = new Chart(ctxBarChart, {
        type: chartBarType,
        data: dataBarChart,
        options: {
            scales: {
                xAxes: [{
                    stacked: true,
                    ticks: {
                        beginAtZero: true,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }],
                yAxes: [{
                    stacked: true,
                }]
            },
        }
    });*@

//create TopPaths bar chart
    const dataTopPathsBarChart = {
        labels: xAxesTopPaths,
        datasets: yAxesTopPaths

    };

    var topPathsChart = new Chart(ctxTopPaths, {
        type: chartBarType,
        data: dataTopPathsBarChart,
        options: {
            indexAxis: 'y',
            scales: {
                xAxes: [{

                    ticks: {
                        beginAtZero: true,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }]

            },
            labels: {
                display: false
            }
        }
    });

    //create ClientIP bar chart
    const dataClientIPBarChart = {
        labels: xAxesClientIP,
        datasets: yAxesClientIP

    };

    var clientIPChart = new Chart(ctxClientIP, {
        type: chartBarType,
        data: dataClientIPBarChart,
        options: {
            indexAxis: 'y',
            scales: {
                xAxes: [{

                    ticks: {
                        beginAtZero: true,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }]

            },
            labels: {
                display: false
            }
        }
    });

    //create ProtocolVersion bar chart
    const dataProtocolVersionBarChart = {
        labels: xAxesProtocolVersion,
        datasets: yAxesProtocolVersion

    };

    var protocolVersionChart = new Chart(ctxProtocolVersion, {
        type: chartBarType,
        data: dataProtocolVersionBarChart,
        options: {
            indexAxis: 'y',
            scales: {
                xAxes: [{

                    ticks: {
                        beginAtZero: true,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }]

            },
            labels: {
                display: false
            }
        }
    });

    //create HttpMethod bar chart
    const dataHttpMethodBarChart = {
        labels: xAxesHttpMethod,
        datasets: yAxesHttpMethod

    };

    var httpMethodChart = new Chart(ctxHttpMethod, {
        type: chartBarType,
        data: dataHttpMethodBarChart,
        options: {
            indexAxis: 'y',
            scales: {
                xAxes: [{

                    ticks: {
                        beginAtZero: true,
                        maxRotation: 0,
                        minRotation: 0
                    }
                }]

            },
            labels: {
                display: false
            }
        }
    });




    $(document).ready(function () {

@*        readDataBarChart();*@
        readDataTopPathsChart();
        readDataClientIPChart();
        readDataProtocolVersionChart();
        readDataHttpMethodChart();

    });



@*   function readDataBarChart() {
        xAxesBarChart.splice(0, xAxesBarChart.length);
        yAxesBarChart.splice(0, yAxesBarChart.length);

        $.ajax({
            url: '@Url.Action("GetDataRequest", "ErrorRequest", new { area = "admin" })',
            type: "get",
            dataType: "json",
            success: function (response) {
                for (var i = 0; i < response.xAxes.length; i++) {
                    xAxesBarChart.push(response.xAxes[i]);
                }

                for (var i = 0; i < response.yAxes.length; i++) {
                    var dataItem = response.yAxes[i];
                    var model = {};
                    model.label = dataItem.label;
                    model.type = dataItem.type;
                    model.stack = dataItem.stack;
                    model.backgroundColor = dataItem.backgroundColor;

                    var data = [];
                    for (var j = 0; j < dataItem.data.length; j++) {
                        data.push(dataItem.data[j]);
                    }
                    model.data = data;

                    yAxesBarChart.push(model);
                }

                console.log(yAxesBarChart);
                barChart.update();
            },
            error: function (xhr) {
            }
        });


    }*@

    function readDataClientIPChart() {
        xAxesClientIP.splice(0, xAxesClientIP.length);
        yAxesClientIP.splice(0, yAxesClientIP.length);

        $.ajax({
            url: '@Url.Action("GetDataClientIP", "RequestPerformance", new { area = "admin" })',
            type: "get",
            dataType: "json",
            success: function (response) {
                for (var i = 0; i < response.xAxes.length; i++) {
                    xAxesClientIP.push(response.xAxes[i]);
                }

                for (var i = 0; i < response.yAxes.length; i++) {
                    var dataItem = response.yAxes[i];
                    var model = {};
                    model.axis = dataItem.axis;
                    model.fill = dataItem.fill;
                    model.borderWidth = dataItem.borderWidth;
                    model.data = dataItem.data;
                    model.backgroundColor = dataItem.backgroundColor;
                    yAxesClientIP.push(model);
                }
                console.log(xAxesClientIP);
                console.log(yAxesClientIP);
                clientIPChart.update();

            },
            error: function (xhr) {
            }
        });


    }

    function readDataTopPathsChart() {
        xAxesTopPaths.splice(0, xAxesTopPaths.length);
        yAxesTopPaths.splice(0, yAxesTopPaths.length);
        $.ajax({
            url: '@Url.Action("GetDataTopPath", "RequestPerformance", new { area = "admin" })',
            type: "get",
            dataType: "json",
            success: function (response) {
                for (var i = 0; i < response.xAxes.length; i++) {
                    xAxesTopPaths.push(response.xAxes[i]);
                }

                for (var i = 0; i < response.yAxes.length; i++) {
                    var dataItem = response.yAxes[i];
                    var model = {};
                    model.axis = dataItem.axis;
                    model.fill = dataItem.fill;
                    model.borderWidth = dataItem.borderWidth;
                    model.data = dataItem.data;
                    model.backgroundColor = dataItem.backgroundColor;
                    yAxesTopPaths.push(model);
                }
                console.log(xAxesTopPaths);
                console.log(yAxesTopPaths);
                topPathsChart.update();

            },
            error: function (xhr) {
            }
        });


    }

    function readDataProtocolVersionChart() {
        xAxesProtocolVersion.splice(0, xAxesProtocolVersion.length);
        yAxesProtocolVersion.splice(0, yAxesProtocolVersion.length);

        $.ajax({
            url: '@Url.Action("GetDataProtocolVersion", "RequestPerformance", new { area = "admin" })',
            type: "get",
            dataType: "json",
            success: function (response) {
                for (var i = 0; i < response.xAxes.length; i++) {
                    xAxesProtocolVersion.push(response.xAxes[i]);
                }

                for (var i = 0; i < response.yAxes.length; i++) {
                    var dataItem = response.yAxes[i];
                    var model = {};
                    model.axis = dataItem.axis;
                    model.fill = dataItem.fill;
                    model.borderWidth = dataItem.borderWidth;
                    model.data = dataItem.data;
                    model.backgroundColor = dataItem.backgroundColor;
                    yAxesProtocolVersion.push(model);
                }
                console.log(xAxesProtocolVersion);
                console.log(yAxesProtocolVersion);
                protocolVersionChart.update();

            },
            error: function (xhr) {
            }
        });


    }

    function readDataHttpMethodChart() {
        xAxesHttpMethod.splice(0, xAxesHttpMethod.length);
        yAxesHttpMethod.splice(0, yAxesHttpMethod.length);

        $.ajax({
            url: '@Url.Action("GetDataHttpMethod", "RequestPerformance", new { area = "admin" })',
            type: "get",
            dataType: "json",
            success: function (response) {
                for (var i = 0; i < response.xAxes.length; i++) {
                    xAxesHttpMethod.push(response.xAxes[i]);
                }

                for (var i = 0; i < response.yAxes.length; i++) {
                    var dataItem = response.yAxes[i];
                    var model = {};
                    model.axis = dataItem.axis;
                    model.fill = dataItem.fill;
                    model.borderWidth = dataItem.borderWidth;
                    model.data = dataItem.data;
                    model.backgroundColor = dataItem.backgroundColor;
                    yAxesHttpMethod.push(model);
                }
                console.log(xAxesClientIP);
                console.log(yAxesClientIP);
                httpMethodChart.update();

            },
            error: function (xhr) {
            }
        });


    }

    function getDataFilter() {
        var dataSource = $("#grid").data("kendoGrid").dataSource;
        var filters = dataSource.filter();
        var allData = dataSource.data();
        var query = new kendo.data.Query(allData);
        var result = query.filter(filters).data;
        return result;
    }
    function getCheckAll() {
        var dataFilterID = [];
        var dataFilter = getDataFilter();
        var check;
        for (var i = 0; i < dataFilter.length; i++) {
            dataFilterID.push(String(dataFilter[i].ID));
        }
        for (var i = 0; i < dataFilterID.length; i++) {
            var index = rowselected.indexOf(dataFilterID[i]);
            if (index != -1) {
                check = true;
            }
            else {
                check = false;
                break;
            }
        }
        return check;
    }

    function childNodeClick(element) {
        var dataID = getCheckAll();
        var id = element.value;
        if (rowselected.indexOf(id) !== -1) {
            rowselected.splice(rowselected.indexOf(id), 1);
        } else {
            rowselected.push(id);
        }
        isCheckedAll = getCheckAll();
        $('#chkAll').prop('checked', isCheckedAll);
    }

    $(function () {
        $(".k-filter").click(function () {
            setTimeout(function () {
                $(".k-filter-menu .k-button").click(function () {
                    setTimeout(function () {
                        rowselected = [];
                        isCheckedAll = getCheckAll();
                        $('#chkAll').prop('checked', isCheckedAll);
                        $('input[name="checkedNodes"]').each(function () {
                            if (rowselected.indexOf(this.value) != -1) {
                                $(this).attr('checked', 'checked');
                            } else {
                                $(this).removeAttr('checked');
                            }
                        });
                    }, 10)
                })
            }, 100);
        });
    });

    function checkAll(e) {

        var rowItems = getDataFilter();
        isCheckedAll = $(e.target).prop('checked');
        if (isCheckedAll) {
            for (var i = 0; i < rowItems.length; i++) {
                var index = rowselected.indexOf(String(rowItems[i].ID));
                if (index == -1) {
                    rowselected.push(String(rowItems[i].ID));
                }
            }
        }
        else if (!isCheckedAll) {
            var dataFilterID = [];
            var dataFilter = getDataFilter();
            for (var i = 0; i < dataFilter.length; i++) {
                dataFilterID.push(String(dataFilter[i].ID));
            }
            for (var i = 0; i < dataFilterID.length; i++) {
                var index = rowselected.indexOf(dataFilterID[i]);
                if (index != -1) {
                    rowselected.splice(index, 1);
                }
            }
        }

        $('input[name="checkedNodes"]').each(function () {
            $(this).prop('checked', isCheckedAll);
        });
    }
    function export_data(data) {
        $("div[class='loader-delete']").hide();

        if (data.status == "Sucess") {
            $("#background-black").css("filter", "contrast(100%)");
            window.parent.show_stack_bottom_right('success', 'Tải dữ liệu nhật ký máy chủ', 'Tải thành công.');
        }
        else {
            alert("Đã xuất hiện lỗi trong quá trình kết xuất dữ liệu!");
            $("#background-black").css("filter", "contrast(100%)");
            window.parent.show_stack_bottom_right('error', 'Tải dữ liệu nhật ký máy chủ', 'Tải không thành công.');
        }
    }

</script>
